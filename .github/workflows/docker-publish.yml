name: Build and publish Docker images

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  actions: read
  contents: read
  packages: write

jobs:
  verify_ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI on tagged commit
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const workflowId = "ci.yml";
            const maxAttempts = 60; // 30 minutes @ 30s intervals
            const delayMs = 30_000;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const res = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflowId,
                event: "push",
                head_sha: sha,
                per_page: 10,
              });

              const runs = res.data.workflow_runs ?? [];
              const completed = runs.find((run) => run.status === "completed");

              if (completed) {
                core.info(
                  `Found completed CI run ${completed.id} for ${sha} with conclusion=${completed.conclusion}`
                );
                if (completed.conclusion === "success") {
                  return;
                }
                core.setFailed(
                  `CI for tagged commit ${sha} is not successful (conclusion=${completed.conclusion}).`
                );
                return;
              }

              core.info(
                `No completed CI run for ${sha} yet (attempt ${attempt}/${maxAttempts}). Waiting...`
              );
              await new Promise((resolve) => setTimeout(resolve, delayMs));
            }

            core.setFailed(
              `Timed out waiting for CI success on tagged commit ${sha}.`
            );

  build_base:
    runs-on: ubuntu-latest
    needs: verify_ci
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}:latest

  build_ha:
    runs-on: ubuntu-latest
    needs: build_base
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push HA image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ha-addon/fitness-habit-tracker/Dockerfile
          push: true
          build-args: |
            BUILD_FROM=ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          tags: |
            ghcr.io/${{ github.repository }}-ha:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}-ha:latest
