upstream nextjs {
    server 127.0.0.1:3001;
}

server {
    listen 3000;

    # HA ingress sends the mount path in this header (example: /api/hassio_ingress/ABC123)
    set $ingress_path $http_x_ingress_path;

    add_header X-Debug-Ingress-Path $ingress_path always;

    # No-store while you're debugging (optional, but helps stop stale HTML/chunks)
    add_header Cache-Control "no-store" always;

    location / {
        # Default: forward the URI as-is
        set $upstream_uri $uri;

        # If HA provided an ingress mount path, strip it from the front of the URI
        # so Next sees normal paths like /, /admin, /_next/..., /api/...
        if ($ingress_path != "") {
            if ($uri ~ ^$ingress_path(.*)$) {
                set $upstream_uri $1;
            }
        }

        proxy_pass http://nextjs$upstream_uri$is_args$args;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
