upstream nextjs {
    server 127.0.0.1:3001;
}

server {
    listen 3000;

    # Pull the dynamic subpath from HA
    set $ingress_path $http_x_ingress_path;
    if ($ingress_path = "") {
        set $ingress_path "/";
    }

    add_header X-Debug-Ingress-Path $ingress_path always;

    location / {
        proxy_pass http://nextjs;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # IMPORTANT: don't let upstream compress HTML or sub_filter can't rewrite it
        proxy_set_header Accept-Encoding "";

        # Only rewrite HTML. Do NOT try to rewrite JS bundles.
        sub_filter_once off;
        sub_filter_types text/html;

        # Ensure every absolute Next asset reference in HTML becomes ingress-prefixed.
        # This fixes the runtime publicPath so chunk loads stop going to "/_next/..." at HA root.
        sub_filter 'src="/_next/'  'src="$ingress_path/_next/';
        sub_filter 'href="/_next/' 'href="$ingress_path/_next/';
        sub_filter 'content="/_next/' 'content="$ingress_path/_next/';
        sub_filter '="/_next/' '="$ingress_path/_next/';
        sub_filter '"/_next/' '"$ingress_path/_next/';
        sub_filter "'/_next/" "'$ingress_path/_next/";

        # (Optional) If you have absolute favicon/manifest refs in HTML, rewrite them too:
        sub_filter 'href="/favicon.ico"' 'href="$ingress_path/favicon.ico"';
        sub_filter 'href="/manifest.json"' 'href="$ingress_path/manifest.json"';

        # WebSocket upgrade (safe even if unused)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
