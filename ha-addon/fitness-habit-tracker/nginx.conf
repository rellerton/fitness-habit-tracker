# /etc/nginx/http.d/default.conf

upstream nextjs {
    server 127.0.0.1:3001;
}

# HA ingress mount path comes in as X-Ingress-Path.
# Use map instead of if (safer + allowed in http context).
map $http_x_ingress_path $ingress_path {
    default $http_x_ingress_path;
    ""      "/";
}

server {
    listen 3000;

    add_header X-Debug-Ingress-Path $ingress_path always;

    # Avoid caching HTML from ingress (stale HTML => chunk mismatch)
    add_header Cache-Control "no-store" always;

    # 1) If request is /api/hassio_ingress/<token>/..., strip that prefix
    #    before proxying to Next so Next sees normal /, /admin, /_next, /api.
    location ~ ^/api/hassio_ingress/[^/]+(?<rest>/.*)$ {
        proxy_pass http://nextjs$rest;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 2) If request is /hassio/ingress/<slug>/..., strip that prefix too.
    location ~ ^/hassio/ingress/[^/]+(?<rest>/.*)$ {
        proxy_pass http://nextjs$rest;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 3) Fallback (covers direct access in non-ingress scenarios)
    location / {
        proxy_pass http://nextjs;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
