upstream nextjs {
    server 127.0.0.1:3001;
}

server {
    listen 3000;

    # HA ingress sends the dynamic mount path in this header (keep for debugging)
    set $ingress_path $http_x_ingress_path;
    if ($ingress_path = "") { set $ingress_path "/"; }

    add_header X-Debug-Ingress-Path $ingress_path always;

    # DO NOT cache HTML through ingress (stale HTML = stale chunk references)
    add_header Cache-Control "no-store" always;

    location / {
        proxy_pass http://nextjs;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Make upstream send plain text so sub_filter can operate
        proxy_set_header Accept-Encoding "";

        # If upstream ignores it, still handle it
        gunzip on;

        # Rewrite redirects from Next (Location: /admin etc). HA ingress usually handles this,
        # but keep it harmlessly correct.
        proxy_redirect off;

        sub_filter_once off;

        # Only rewrite content types that are safe to rewrite
        sub_filter_types
            text/html
            application/javascript
            text/javascript
            text/css
            application/json;

        # ---------------------------------------------------------------------
        # CRITICAL FIX: make Next asset and API URLs RELATIVE (remove leading '/')
        #
        # This prevents the browser from requesting:
        #   http://<HA>:8123/_next/...
        # and instead requests:
        #   http://<HA>:8123/api/hassio_ingress/<token>/_next/...
        # automatically, because it's relative to the current ingress path.
        # ---------------------------------------------------------------------

        # --- Next assets: "/_next/..." -> "_next/..." ---
        sub_filter '"/_next/' '"_next/';
        sub_filter "'/_next/" "'_next/";
        sub_filter '="/_next/' '="_next/';
        sub_filter "='/_next/" "='_next/";
        sub_filter 'href="/_next/' 'href="_next/';
        sub_filter "href='/_next/" "href='_next/";
        sub_filter 'src="/_next/' 'src="_next/';
        sub_filter "src='/_next/" "src='_next/";

        # --- API paths: "/api/..." -> "api/..." ---
        sub_filter '"/api/' '"api/';
        sub_filter "'/api/" "'api/";
        sub_filter '="/api/' '="api/';
        sub_filter "='/api/" "='api/";
        sub_filter 'fetch("/api/' 'fetch("api/';
        sub_filter "fetch('/api/" "fetch('api/";
        sub_filter 'axios.get("/api/' 'axios.get("api/';
        sub_filter "axios.get('/api/" "axios.get('api/";

        # WebSocket headers (harmless in prod, needed in some setups)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
