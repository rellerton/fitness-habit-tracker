upstream nextjs {
    server 127.0.0.1:3001;
}

server {
    listen 3000;

    # HA ingress sends the dynamic mount path in this header
    set $ingress_path $http_x_ingress_path;
    if ($ingress_path = "") { set $ingress_path "/"; }

    add_header X-Debug-Ingress-Path $ingress_path always;

    # DO NOT cache HTML through ingress (stale rewritten HTML = broken chunks/hydration)
    add_header Cache-Control "no-store" always;

    location / {
        proxy_pass http://nextjs;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Make upstream send plain text so sub_filter can operate
        proxy_set_header Accept-Encoding "";

        # If upstream ignores it, still handle it
        gunzip on;

        # Rewrite redirects from Next (Location: /admin => /api/hassio_ingress/<token>/admin)
        proxy_redirect ~^(/.*)$ $ingress_path$1;

        sub_filter_once off;

        # Only rewrite content types that are safe to rewrite
        sub_filter_types
            text/html
            application/javascript
            text/javascript
            text/css
            application/json;

        # --- Next assets: force /_next to live under ingress path ---
        sub_filter '"/_next/' '"$ingress_path/_next/';
        sub_filter "'/_next/" "'$ingress_path/_next/";
        sub_filter 'href="/_next/' 'href="$ingress_path/_next/';
        sub_filter "href='/_next/" "href='$ingress_path/_next/";
        sub_filter 'src="/_next/' 'src="$ingress_path/_next/';
        sub_filter "src='/_next/" "src='$ingress_path/_next/";

        # --- API paths: if any bundles contain absolute /api/... ---
        sub_filter '"/api/' '"$ingress_path/api/';
        sub_filter "'/api/" "'$ingress_path/api/";
        sub_filter 'fetch("/api/' 'fetch("$ingress_path/api/';
        sub_filter "fetch('/api/" "fetch('$ingress_path/api/";

        # WebSocket headers (harmless in prod, needed in some setups)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
