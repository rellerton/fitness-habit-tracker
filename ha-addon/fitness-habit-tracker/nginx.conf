# /etc/nginx/http.d/default.conf

upstream nextjs {
    server 127.0.0.1:3001;
}

# HA ingress mount path comes in via X-Ingress-Path.
# Use map (no "if" required).
map $http_x_ingress_path $ingress_path {
    default $http_x_ingress_path;
    ""      "";
}

server {
    listen 3000;

    add_header X-Debug-Ingress-Path $ingress_path always;

    # HTML must not be cached through ingress or you will get chunk mismatch/hydration issues.
    location = / {
        add_header Cache-Control "no-store" always;
        proxy_pass http://nextjs;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header Accept-Encoding "";
        gunzip on;

        sub_filter_once off;
        sub_filter_types text/html;

        # Rewrite Next asset root paths into ingress mount
        sub_filter 'href="/_next/'  'href="'$ingress_path'/_next/';
        sub_filter 'src="/_next/'   'src="'$ingress_path'/_next/';
        sub_filter '"/_next/'       '"'$ingress_path'/_next/';
        sub_filter "'/_next/"       "'"$ingress_path"'/_next/";

        # Rewrite absolute API calls
        sub_filter '"/api/'         '"'$ingress_path'/api/';
        sub_filter "'/api/"         "'"$ingress_path"'/api/";
        sub_filter 'fetch("/api/'   'fetch("'$ingress_path'/api/';
        sub_filter "fetch('/api/"   "fetch('"$ingress_path"'/api/";
    }

    # Everything else
    location / {
        # DO NOT cache HTML (Next chunk hash mismatch hell)
        add_header Cache-Control "no-store" always;

        proxy_pass http://nextjs;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # sub_filter cannot work on gzipped output
        proxy_set_header Accept-Encoding "";
        gunzip on;

        # Rewrite redirects from Next (Location: /admin -> <ingress>/admin)
        proxy_redirect ~^(/.*)$ $ingress_path$1;

        sub_filter_once off;

        # Only rewrite stuff that might contain those absolute paths
        sub_filter_types
            text/html
            application/javascript
            text/javascript
            text/css
            application/json;

        # Next static assets
        sub_filter 'href="/_next/'  'href="'$ingress_path'/_next/';
        sub_filter 'src="/_next/'   'src="'$ingress_path'/_next/';
        sub_filter '"/_next/'       '"'$ingress_path'/_next/';
        sub_filter "'/_next/"       "'"$ingress_path"'/_next/";

        # API
        sub_filter '"/api/'         '"'$ingress_path'/api/';
        sub_filter "'/api/"         "'"$ingress_path"'/api/";
        sub_filter 'fetch("/api/'   'fetch("'$ingress_path'/api/';
        sub_filter "fetch('/api/"   "fetch('"$ingress_path"'/api/";

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
